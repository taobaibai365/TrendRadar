# TrendRadar 错误记录

本文档记录 TrendRadar 项目开发过程中遇到的错误、根本原因分析、解决方案和经验教训。

---

## 📋 目录

- [功能错误](#功能错误)
- [设计错误](#设计错误)
- [流程错误](#流程错误)
- [安全错误](#安全错误)

---

## 🐛 功能错误

### 数据源删除失效

**发生时间**：2026-01-11
**影响范围**：数据源管理功能
**严重程度**：高

**错误现象**：
- 通过配置界面删除数据源时，前端显示删除成功
- 但配置文件中的数据源并未实际删除
- 后台调度器继续尝试抓取已删除的数据源
- 错误日志持续出现（如华尔街见闻的 403 错误）

**根本原因**：
1. API 接口使用旧的 `SourceManager`（读取 `config/sources.json`）
2. 实际配置存储在 `config/source_groups.json`，由 `SourceGroupManager` 管理
3. `SourceGroupManager` 缺少删除单个数据源的方法

**解决方案**：
1. 在 `trendradar/sources/group_manager.py` 中添加：
   - `remove_source_from_group(group_id, source_id)` - 从分组中删除指定数据源
   - `find_source_group(source_id)` - 查找包含指定数据源的分组ID
2. 修改 `api/main.py` 的 API 端点：
   - `GET /api/sources` - 现在从 `SourceGroupManager` 读取所有分组的数据源
   - `DELETE /api/sources/{source_id}` - 使用 `SourceGroupManager` 删除数据源并保存配置

**验证结果**：
- ✅ 删除操作立即生效并保存到 `config/source_groups.json`
- ✅ 后台调度器停止抓取已删除的数据源
- ✅ 不再有相关错误日志

**经验教训**：
- 代码重构时要检查所有相关代码
- 不能只改前端或只改后端，要同步修改
- 删除操作要立即保存到配置文件
- 确保架构一致性，使用统一的 Manager

**相关变更**：[[CHANGELOG.md#2026-01-11]]
**相关设计**：[[DESIGN.md#数据源分组架构]]

---

### 数据库连接被过早关闭

**发生时间**：2026-01-11
**影响范围**：AI 分析功能
**严重程度**：高

**错误现象**：
```
[AI Analyzer] 保存分析结果失败: Cannot operate on a closed database.
分析流程执行出错: Cannot operate on a closed database.
[本地存储] 关闭数据库连接: output/rss/2026-01-11.db
Error in manual fetch task: Cannot operate on a closed database.
```

**根本原因**：
在 `trendradar/core/ai_analyzer.py` 的两个函数中：
- `_save_analysis_results` (line 336-337)
- `_create_link_summary_card` (line 471-472)

在 `finally` 块中直接调用了 `conn.close()`：
```python
finally:
    if 'conn' in locals():
        conn.close()  # ❌ 问题所在
```

这些连接是从 `storage._db_connections` 缓存中获取的，直接关闭连接后：
- 连接被关闭
- 但 `_db_connections` 中仍保存着已关闭连接的引用
- 后续代码再次调用 `storage._get_connection()` 时，会返回这个已关闭的连接

**解决方案**：
移除手动关闭连接的代码，让 `LocalStorageBackend` 统一管理连接生命周期

**验证结果**：
- ✅ 数据库连接不会再被过早关闭
- ✅ 连接由 `LocalStorageBackend` 统一管理
- ✅ 程序退出时调用 `storage.cleanup()` 关闭所有连接

**经验教训**：
- 连接池模式的连接不能手动关闭
- 要由连接池管理器统一管理连接生命周期
- 使用连接池时要了解其工作原理
- 不能在 `finally` 块中随意关闭来自连接池的连接

**相关变更**：[[CHANGELOG.md#2026-01-11]]

---

## 🎨 设计错误

### 功能实现不完整

**发生时间**：2026-01-10 晚
**影响范围**：数据源分组功能
**严重程度**：高

**错误现象**：
- 只实现了后端 API，没有实现前端 UI
- 用户无法通过界面管理数据源分组
- 功能无法使用

**用户反馈**：
> "Obsidian 插件配置界面没有变化？我记得我强调过，配置除非必要，凡是业务相关、评估用户使用过程中会修改的，都应由用户进行 前端 配置"

**根本原因**：
1. 没有充分理解用户需求
2. 认为实现了后端 API 就完成了
3. 忘记了"前端优先原则"

**解决方案**：
1. 补充实现前端 UI - 数据源分组管理界面
2. 实现分组与数据源的关联
3. 部署到测试 vault

**经验教训**：
- 📌 **重要**：所有业务配置必须通过前端界面管理
- 📌 **重要**：功能要完整实现，不能只做一半
- 📌 **重要**：后端和前端要同步完成
- 📌 **重要**：实现后要编译部署到测试环境

**相关变更**：[[CHANGELOG.md#2026-01-10]]

---

### 配置流程顺序错误

**发生时间**：2026-01-11 上午
**影响范围**：配置管理
**严重程度**：中

**错误现象**：
- Tab 顺序不符合使用流程
- 用户不知道应该先配置什么

**用户反馈**：
> "配置流程应该是：先配置 可用的 AI 服务列表，再配置数据源分组，在数据源分组中选择已有的 AI 服务、数据源"

**根本原因**：
- 没有从用户角度思考配置流程
- Tab 顺序随意排列

**解决方案**：
1. 调整 Tab 顺序：
   - 常规设置
   - **AI 服务** ⭐（新增，优先级最高）
   - 数据源管理
   - 数据源分组
   - 内容过滤
   - 去重设置
   - 系统设置

2. 创建 AI 服务管理模块
3. 简化分组配置（从复杂表单改为服务选择）

**经验教训**：
- 配置流程要符合逻辑：先配置基础资源，再组合使用
- Tab 顺序影响用户体验，要按照使用流程排列
- 要从用户心智模型出发设计界面

**相关变更**：[[CHANGELOG.md#2026-01-11]]
**相关设计**：[[DESIGN.md#配置管理架构]]

---

### 参数不一致

**发生时间**：2026-01-11 凌晨
**影响范围**：数据源管理
**严重程度**：中

**错误现象**：
- 编辑分组中添加数据源时，RSS 订阅的参数数量与数据源管理 tab 中添加 RSS 订阅时的参数不一样
- 缺少保留天数、最大条目数、抓取计划等参数

**用户反馈**：
> "编辑分组中添加数据源时，如果是新的数据源，比如 rss 订阅，参数数量与数据源管理 tab 中添加 rss 订阅时的参数不一样，少了"

**根本原因**：
- 复制代码时遗漏了部分参数
- 没有对比不同地方的同一功能
- 缺少代码审查

**解决方案**：
补充完整的数据源参数：
- 保留天数（retention_days）
- 最大条目数（max_items）
- 抓取计划（schedule）
- 使用代理（use_proxy）
- 启用状态（enabled）

**经验教训**：
- 同一功能的参数要保持一致
- 不同地方的同一功能要有相同的配置项
- 复制代码时要仔细检查
- 要进行对比验证

**相关变更**：[[CHANGELOG.md#2026-01-11]]

---

## 🔄 流程错误

### 缺少工作流程

**发生时间**：2026-01-10 晚
**影响范围**：开发流程
**严重程度**：高

**错误现象**：
- 实现功能后没有进行评审
- 没有撰写 CHANGELOG
- 没有编写测试用例
- 没有进行自测

**用户反馈**：
> "我之前要求过，你在每次进行完编码修改之后，都要对本次修改的需求内容、代码实现进行评审，如果评审没有问题，需要撰写 changelog、测试用例场景，因为我认为在编写这些内容的过程中你会发现自己逻辑或需求理解上是否存在问题和漏洞，也会发现代码实现和需求之间的差异，也可以从测试使用的角度发现不合理之处，这样做了之后，我认为你也应该进行自测，而不是所有的都依赖人来测试，人的测试是属于最后的使用者验证了。"

**根本原因**：
- 没有建立规范的工作流程
- 追求速度，忽视了质量
- 没有充分理解文档的重要性

**解决方案**：
1. 补充完整的评审文档
2. 创建测试用例和自测报告
3. 建立标准工作流程（见 [[workflow.md]]）

**经验教训**：
- 📌 **重要**：必须遵循完整的工作流程
- 📌 **重要**：评审→changelog→测试→自测，一步不能少
- 📌 **重要**：文档是质量保证的重要环节
- 📌 **重要**：在编写文档的过程中会发现很多问题

**相关变更**：[[CHANGELOG.md#2026-01-10]]

---

### UI 设计缺少迭代

**发生时间**：2026-01-11 凌晨
**影响范围**：UI 设计
**严重程度**：中

**错误现象**：
- 第一次 UI 设计不符合用户需求
- 需要多次反馈和修改
- 浪费开发时间

**用户反馈**：
> "分组编辑配置界面也不够紧凑和友好简洁，我强调过我喜欢 Apple 的设计风格"
> "编辑分组的 AI 配置部分，应该有一个选项下来，用来选择该分组的 AI 分析处理是采用分阶段方式，还是整体方式"

**根本原因**：
- 没有充分理解用户的设计偏好
- UI 设计没有提前和用户确认
- 缺少设计评审环节

**解决方案**：
1. 重新设计 UI，采用 Apple 风格
2. 紧凑布局，圆角阴影
3. 添加模式下拉选择器
4. 实现 Tab 切换功能

**经验教训**：
- UI 设计要反复打磨，不能一次完成
- 要充分听取用户反馈并快速迭代
- 要了解用户的设计偏好
- 设计前要和用户确认

**相关变更**：[[CHANGELOG.md#2026-01-11]]

---

## 🔒 安全错误

### API Token 泄露

**发生时间**：2026-01-10
**影响范围**：代码仓库
**严重程度**：高

**错误现象**：
- DeepSeek API token 被提交到 GitHub
- 两个 token 都暴露在代码中

**用户报告**：
> "发现我的 deepseek 的 apitoken 被提交到了 GitHub 中暴露了出来"

**发现的敏感信息**：
- `config/config.yaml:31` - `sk-e6e810d6bcf54ad385d2f86aaf0483c0`
- `config/ai_config.json:3` - `sk-f58b54fadeb241b3bad8f8f523d1bcec`

**根本原因**：
1. 项目开始时没有配置好 .gitignore
2. 敏感信息硬编码在配置文件中
3. 提交前没有检查敏感信息

**解决方案**：
1. 清空敏感信息
2. 更新 .gitignore，添加敏感配置文件
3. 使用 `git rm --cached` 从仓库中删除文件
4. 提交并推送到 GitHub
5. 指导用户撤销已暴露的 token

**验证结果**：
- ✅ 敏感信息已从仓库移除
- ✅ 防止未来提交敏感文件
- ⚠️ 需要用户手动撤销旧 token

**经验教训**：
- 敏感信息绝对不能提交到代码仓库
- 要在项目开始时就配置好 .gitignore
- API token 应该使用环境变量，不应硬编码
- 提交前要检查敏感信息

**相关变更**：[[CHANGELOG.md#2026-01-10]]
**相关需求**：[[requirements.md#安全性]]

---

### 配置数据丢失

**发生时间**：2026-01-11 凌晨
**影响范围**：用户配置
**严重程度**：中

**错误现象**：
- 修改 AI 配置结构后，之前的配置不见了

**用户反馈**：
> "之前配置的数据丢失了？？"

**根本原因**：
- 修改 AI 配置结构时，没有正确处理旧配置的兼容性
- 没有实现数据迁移逻辑

**解决方案**：
1. 实现旧配置自动迁移
2. 保留向后兼容的字段
3. 智能检测配置格式

**经验教训**：
- 修改数据结构时必须考虑向后兼容
- 要实现自动迁移逻辑
- 保留旧字段的兼容性
- 数据结构变更要谨慎

**相关变更**：[[CHANGELOG.md#2026-01-11]]

---

## 📅 更新记录

### 2026-01-11
- 创建 mistake.md
- 记录了功能、设计、流程、安全四个方面的错误
- 建立了与 CHANGELOG.md 和 DESIGN.md 的双链关系

---

*本文档随项目发展持续更新中*
